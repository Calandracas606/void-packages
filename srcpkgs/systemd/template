# Template file for 'systemd-boot-efistub'
pkgname=systemd
version=255.2
revision=1
build_style=meson
configure_args=" -Dsbat-distro=void -Dsbat-distro-summary=Void -Dsbat-distro-pkgname=${pkgname}
 -Dsbat-distro-version="${version}_${revision}"
 -Dsbat-distro-url=https://github.com/void-linux/void-packages/issues
 -Dman=enabled
 -Dutmp=false
 -Dldconfig=false
 -Dlocaled=false
 -Duserdb=false
 -Dhomed=false
 -Dnss-myhostname=false
 -Dnss-mymachines=false
 -Dnss-resolve=false
 -Dnss-systemd=false
 -Dsysusers=false
 -Dhtml=false
 -Dtranslations=false
"
# most of these aren't needed for what we're building but it's easier than patching
hostmakedepends="pkg-config gperf python3-Jinja2 python3-pyelftools libxslt docbook-xsl git rsync quota kmod kdb cmake kexec-tools kbd bpftool"
makedepends="libcap-devel libmount-devel systemtap-devel libbpf-devel glib-devel libzstd-devel liblz4-devel openssl-devel
	bash-completion
	gettext-devel
	kbd
        libseccomp-devel
        libblkid-devel
        libkmod-devel
        pam-devel
        cryptsetup-devel
        libaudit-devel
        acl-devel
        libfdisk-devel
        libselinux-devel
        liblzma-devel
        libgcrypt-devel
        qrencode-devel
        libmicrohttpd-devel
        libidn2-devel
        gnutls-devel
        elfutils-devel
        polkit-devel
	libpwquality-devel
	libfido2-devel
	passwdqc-devel
	libseccomp-devel
	libselinux-devel
	libapparmor-devel
	xen-devel
	tpm2-tss-devel
	libcurl-devel
	libiptcdata-devel
	libxkbcommon-devel
	llvm17-devel"
depends="util-linux"
short_desc="systemd init"
maintainer="Daniel Martinez <danielmartinez@cock.li>"
license="LGPL-2.1-or-later"
homepage="https://www.freedesktop.org/wiki/Software/systemd/systemd-boot/"
distfiles="https://github.com/systemd/systemd-stable/archive/refs/tags/v${version}.tar.gz"
checksum=ba7354a742dc9a8bb7dbeaa40cbf7cf2ca84f506d5b7ae5ab8d14c8eecb7aca0
make_check=no  # missing printf.h
#provides="eudev-libudev libudev eudev udev elogind logind"

if [ "${XBPS_TARGET_LIBC}" = glibc ]; then
	makedepends+=" libxcrypt-devel"
else
	configure_args+=" -Dgshadow=false"
	CFLAGS+=" -D__UAPI_DEF_ETHHDR=0"
	CXXFLAGS+=" -D__UAPI_DEF_ETHHDR=0"
fi

case "${XBPS_TARGET_MACHINE}" in
	x86_64*)  _efi_arch="x64"     ;;
	i686*)    _efi_arch="ia32"    ;;
	aarch64*) _efi_arch="aa64"    ;;
	arm*)     _efi_arch="arm"     ;;
	riscv64*) _efi_arch="riscv64" ;;
	*) broken="unknown efi architecture" ;;
esac

#post_patch() {
#	if [ "${XBPS_TARGET_LIBC}" = musl ]; then
#		vsed -e 's,<linux/if_ether.h>,<netinet/if_ether.h>,g' \
#			-i src/basic/linux/cfm_bridge.h \
#			-i src/basic/linux/if_bonding.h \
#			-i src/basic/linux/if_bridge.h \
#			-i src/basic/linux/if_tun.h \
#			-i src/basic/linux/mrp_bridge.h \
#			-i src/basic/linux/netdevice.h \
#			-i src/basic/socket-util.h \
#			-i src/network/netdev/bareudp.h \
#			-i src/network/netdev/macsec.c \
#			-i src/shared/linux/ethtool.h
#	fi
#}

#_bins=(ukify)
#_mans=(man/ukify.1 man/systemd-stub.7)
#_efis=("src/boot/efi/linux${_efi_arch}.efi.stub")
#make_build_target="${_bins[*]} ${_mans[*]} ${_efis[*]}"

#do_install() {
#	for b in "${_bins[@]}"; do
#		vbin "build/$b"
#	done
#
#	for m in build/man/*.[0-9]; do
#		vman "$m"
#	done
#
#	for e in "${_efis[@]}"; do
#		vinstall "build/$e" 644 usr/lib/systemd/boot/efi
#	done
#}

#ukify_package() {
#	short_desc="Unified Kernel Image creation tool from systemd-boot"
#	depends="python3-pefile"
#	pkg_install() {
#		vmove usr/bin/ukify
#		vmove usr/share/man/man1/ukify.1
#	}
#}

systemd-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/share/man/man3
		vmove usr/include
		vmove usr/lib/pkgconfig
		vmove usr/share/pkgconfig
		vmove "usr/lib/*.so"
	}
}

systemd-logind_package() {
	provides="logind"
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - logind components"
	pkg_install() {
		vmove usr/bin/busctl
		vmove usr/share/bash-completion/completions/busctl
		vmove usr/share/man/man1/busctl.1
		vmove usr/share/man/man5/sleep.conf.d.5
		vmove usr/share/zsh/site-functions/_busctl

		vmove usr/bin/loginctl
		vmove usr/lib/udev/rules.d/70-power-switch.rules
		vmove usr/lib/udev/rules.d/70-uaccess.rules
		vmove usr/lib/udev/rules.d/71-seat.rules
		vmove usr/lib/udev/rules.d/73-seat-late.rules
		vmove usr/share/bash-completion/completions/loginctl
		vmove usr/share/dbus-1/system-services/org.freedesktop.login1.service
		vmove usr/share/dbus-1/system.d/org.freedesktop.login1.conf
		vmove usr/share/man/man1/loginctl.1
		vmove usr/share/man/man5/logind.conf.5
		vmove usr/share/man/man5/logind.conf.d.5
		vmove usr/share/man/man5/org.freedesktop.login1.5
		vmove usr/share/polkit-1/actions/org.freedesktop.login1.policy
		vmove usr/share/zsh/site-functions/_loginctl
	}
}

systemd-udev_package() {
	provides="eudev udev"
	depends="${sourcepkg}-libudev>=${version}_${revision}"
	short_desc+=" - udev components"
	pkg_install() {
		vmove etc/udev/udev.conf
		vmove usr/bin/udevadm
		vmove usr/lib/udev/ata_id
		vmove usr/lib/udev/cdrom_id
		vmove usr/lib/udev/dmi_memory_id
		vmove usr/lib/udev/fido_id
		vmove usr/lib/udev/hwdb.d/20-OUI.hwdb
		vmove usr/lib/udev/hwdb.d/20-acpi-vendor.hwdb
		vmove usr/lib/udev/hwdb.d/20-bluetooth-vendor-product.hwdb
		vmove usr/lib/udev/hwdb.d/20-dmi-id.hwdb
		vmove usr/lib/udev/hwdb.d/20-net-ifname.hwdb
		vmove usr/lib/udev/hwdb.d/20-pci-classes.hwdb
		vmove usr/lib/udev/hwdb.d/20-pci-vendor-model.hwdb
		vmove usr/lib/udev/hwdb.d/20-sdio-classes.hwdb
		vmove usr/lib/udev/hwdb.d/20-sdio-vendor-model.hwdb
		vmove usr/lib/udev/hwdb.d/20-usb-classes.hwdb
		vmove usr/lib/udev/hwdb.d/20-usb-vendor-model.hwdb
		vmove usr/lib/udev/hwdb.d/20-vmbus-class.hwdb
		vmove usr/lib/udev/hwdb.d/60-autosuspend-fingerprint-reader.hwdb
		vmove usr/lib/udev/hwdb.d/60-autosuspend.hwdb
		vmove usr/lib/udev/hwdb.d/60-evdev.hwdb
		vmove usr/lib/udev/hwdb.d/60-input-id.hwdb
		vmove usr/lib/udev/hwdb.d/60-keyboard.hwdb
		vmove usr/lib/udev/hwdb.d/60-seat.hwdb
		vmove usr/lib/udev/hwdb.d/60-sensor.hwdb
		vmove usr/lib/udev/hwdb.d/70-analyzers.hwdb
		vmove usr/lib/udev/hwdb.d/70-av-production.hwdb
		vmove usr/lib/udev/hwdb.d/70-cameras.hwdb
		vmove usr/lib/udev/hwdb.d/70-joystick.hwdb
		vmove usr/lib/udev/hwdb.d/70-mouse.hwdb
		vmove usr/lib/udev/hwdb.d/70-pda.hwdb
		vmove usr/lib/udev/hwdb.d/70-pointingstick.hwdb
		vmove usr/lib/udev/hwdb.d/70-touchpad.hwdb
		vmove usr/lib/udev/hwdb.d/80-ieee1394-unit-function.hwdb
		vmove usr/lib/udev/mtd_probe
		vmove usr/lib/udev/rules.d/50-udev-default.rules
		vmove usr/lib/udev/rules.d/60-autosuspend.rules
		vmove usr/lib/udev/rules.d/60-block.rules
		vmove usr/lib/udev/rules.d/60-cdrom_id.rules
		vmove usr/lib/udev/rules.d/60-drm.rules
		vmove usr/lib/udev/rules.d/60-evdev.rules
		vmove usr/lib/udev/rules.d/60-fido-id.rules
		vmove usr/lib/udev/rules.d/60-input-id.rules
		vmove usr/lib/udev/rules.d/60-persistent-alsa.rules
		vmove usr/lib/udev/rules.d/60-persistent-input.rules
		vmove usr/lib/udev/rules.d/60-persistent-storage-tape.rules
		vmove usr/lib/udev/rules.d/60-persistent-storage.rules
		vmove usr/lib/udev/rules.d/60-persistent-v4l.rules
		vmove usr/lib/udev/rules.d/60-sensor.rules
		vmove usr/lib/udev/rules.d/60-serial.rules
		vmove usr/lib/udev/rules.d/64-btrfs.rules
		vmove usr/lib/udev/rules.d/70-camera.rules
		vmove usr/lib/udev/rules.d/70-joystick.rules
		vmove usr/lib/udev/rules.d/70-memory.rules
		vmove usr/lib/udev/rules.d/70-mouse.rules
		vmove usr/lib/udev/rules.d/70-touchpad.rules
		vmove usr/lib/udev/rules.d/75-net-description.rules
		vmove usr/lib/udev/rules.d/75-probe_mtd.rules
		vmove usr/lib/udev/rules.d/78-sound-card.rules
		vmove usr/lib/udev/rules.d/80-drivers.rules
		vmove usr/lib/udev/rules.d/81-net-dhcp.rules
		vmove usr/lib/udev/scsi_id
		vmove usr/lib/udev/v4l_id
		vmove usr/share/man/man5/udev.conf.5
		vmove usr/share/man/man7/hwdb.7
		vmove usr/share/man/man7/udev.7
		vmove usr/share/man/man8/udevadm.8
	}
}

systemd-libudev_package() {
	provides="eudev-libudev libudev"
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - udev runtime library"
	pkg_install() {
		vmove "usr/lib/libudev.so.*"
	}
}

systemd-extra_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - misc extra files"
	pkg_install() {
		vmove usr/bin/resolvconf
	}
}
