# Template file for 'libkrunfw'
pkgname=libkrunfw
version=4.7.1
revision=1
_kernel_version=6.12.3
archs="x86_64* aarch64*"
build_style=gnu-makefile
hostmakedepends="python3-pyelftools tar xz bc cpio flex perl elfutils-devel"
short_desc="Dynamic library bundling the guest payload consumed by libkrun"
maintainer="Daniel Martinez <danielmartinez@cock.li>"
license="GPL-2.0-only AND LGPL-2.1-only"
homepage="https://github.com/containers/libkrunfw"
distfiles="https://github.com/containers/libkrunfw/archive/refs/tags/v${version}.tar.gz
${KERNEL_SITE}/kernel/v${_kernel_version%%.*}.x/linux-${_kernel_version}.tar.xz"
checksum="e137f6bc7a78f2448bb06058284574cbdda55063f3d75fae501ae753e8ee0a87
 c89809cc777d50f1ea484a118630281a26383707a0e752c96fd834f6e765deae"

skip_extraction="linux-${_kernel_version}.tar.xz"


do_build() {
	local _arch _cross

	case "$XBPS_TARGET_MACHINE" in
		x86_64*) _arch=x86_64;;
		aarch64*) _arch=arm64 ;;
	esac

	if [ "$CROSS_BUILD" ]; then
		_cross="CROSS_COMPILE=${XBPS_CROSS_TRIPLET}-"
	fi

	export LDFLAGS=

	make ARCH=$_arch ${_cross} ${makejobs}
}

post_extract() {
	mkdir tarballs
	vsrccopy linux-${_kernel_version}.tar.xz tarballs
}
