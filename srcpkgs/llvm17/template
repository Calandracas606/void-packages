# Template file for 'llvm17'
pkgname=llvm17
version=17.0.6
revision=1
build_wrksrc=llvm
build_style=cmake
_ext_suffix=".cpython-${py3_ver/./}-linux-${XBPS_TARGET_LIBC/glibc/gnu}.so"
configure_args="
 -DCMAKE_INSTALL_PREFIX=/usr/lib/llvm17
 -DCMAKE_BUILD_TYPE=Release -Wno-dev
 -DENABLE_LINKER_BUILD_ID=YES
 -DSPHINX_WARNINGS_AS_ERRORS=NO
 -DLIBCXX_CXX_ABI=libcxxabi
 -DLIBCXX_ENABLE_STATIC_ABI_LIBRARY=YES
 -DLIBCXXABI_USE_LLVM_UNWINDER=YES
 -DLIBCXXABI_ENABLE_STATIC_UNWINDER=YES
 -DLIBOMP_ENABLE_SHARED=YES
 -DLIBOMP_INSTALL_ALIASES=NO
 -DLLVM_VERSION_SUFFIX=
 -DLLVM_INCLUDE_DOCS=YES
 -DLLVM_BUILD_DOCS=YES
 -DLLVM_ENABLE_SPHINX=YES
 -DLLVM_INSTALL_UTILS=YES
 -DLLVM_BUILD_LLVM_DYLIB=YES
 -DLLVM_LINK_LLVM_DYLIB=YES
 -DLLVM_ENABLE_RTTI=YES
 -DLLVM_ENABLE_FFI=YES
 -DLLVM_BINUTILS_INCDIR=/usr/lib/llvm17/include
 -DLLVM_ENABLE_PER_TARGET_RUNTIME_DIR=NO
 -DLLDB_USE_SYSTEM_SIX=YES
 -DLLDB_PYTHON_RELATIVE_PATH=lib/python${py3_ver}/site-packages
 -DLLDB_PYTHON_EXE_RELATIVE_PATH=bin/python${py3_ver}
 -DLLDB_PYTHON_EXT_SUFFIX=$_ext_suffix"
hostmakedepends="perl python3 zlib-devel libffi-devel swig python3-Sphinx
 python3-recommonmark python3-sphinx-automodapi python3-sphinx-markdown-tables
 pkg-config"
makedepends="python3-devel zlib-devel elfutils-devel libffi-devel libedit-devel
 libxml2-devel binutils-devel"
depends="libllvm17>=${version}_${revision}"
short_desc="Low Level Virtual Machine"
maintainer="Orphaned <orphan@voidlinux.org>"
license="Apache-2.0"
homepage="https://www.llvm.org"
distfiles="https://github.com/llvm/llvm-project/releases/download/llvmorg-${version}/llvm-project-${version}.src.tar.xz"
checksum=58a8818c60e6627064f312dbf46c02d9949956558340938b71cf731ad8bc0813
lib32disabled=yes
python_version=3

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	configure_args+=" -DLIBCXX_HAS_MUSL_LIBC=YES
	 -DCOMPILER_RT_BUILD_GWP_ASAN=OFF"
fi

# "operand out of range" assembler failures
case "$XBPS_TARGET_MACHINE" in
	ppc64*) ;;
	ppc*) configure_args+=" -DCLANG_ENABLE_CLANGD=OFF" ;;
esac

# disable libc & llvm-libgcc
_enable_runtimes="libcxx;libcxxabi;libunwind;compiler-rt;pstl"
_enable_projects="clang;clang-tools-extra;lld;mlir"

_lldb_enable=yes
_libomp_enable=no
_bolt_enable=no
_flang_enable=no
_polly_enable=no

case "$XBPS_TARGET_MACHINE" in
	ppc64le*) ;;
	ppc*|i686*|riscv64*) _lldb_enable=no ;;
esac

case "$XBPS_TARGET_MACHINE" in
	x86_64*|aarch64*|ppc64*) _libomp_enable=yes;;
esac

case "$XBPS_TARGET_MACHINE" in
	x86_64*) _bolt_enable=yes ;;
esac

if [ "$XBPS_TARGET_WORDSIZE" = 64 ]; then
	_flang_enable=yes
fi

subpackages="clang-tools-extra17"

# must go before clang
if [ "$_libomp_enable" = "yes" ]; then
	_enable_runtimes+=";openmp"
	subpackages+=" libomptarget17 libomp17 libomp17-devel"
	# because of cmake nonsense referencing libomptarget.so.*
	depends+=" libomp17>=${version}_${revision}"
	if [ "$CROSS_BUILD" ]; then
		# Seems to require a full host llvm/clang build
		configure_args+=" -DLIBOMPTARGET_BUILD_CUDA_PLUGIN=OFF"
		configure_args+=" -DLIBOMPTARGET_BUILD_AMDGPU_PLUGIN=OFF"
	fi
fi

subpackages+=" clang17 clang-analyzer17
 libclang17 libclang-cpp17 libllvm17
 llvm-libunwind17 llvm-libunwind-17devel libcxx17 libcxx17-devel
 libcxxabi17 libcxxabi17-devel"

if [ "$_lldb_enable" = "yes" ]; then
	# XXX fails to cross compile due to python
	_enable_projects+=";lldb"
	subpackages+=" lldb17 lldb17-devel"
fi

if [ "$_bolt_enable" = yes ]; then
	_enable_projects+=";bolt"
	subpackages+=" bolt17 libbolt17-devel"
fi

if [ "$_flang_enable" = yes ]; then
	_enable_projects+=";flang"
	subpackages+=" flang17;libflang17-devel"
fi

if [ "$_polly_enable" = yes ]; then
	_enable_projects+=";polly"
	subpackages+=" libpolly17-devel"
fi

if [ "$_libfuzzer_enable" = yes ]; then
	subpackages+=" libfuzzer17-devel"
fi

subpackages+=" lld17 lld17-devel"

configure_args+=" -DLLVM_ENABLE_RUNTIMES=${_enable_runtimes}"
configure_args+=" -DLLVM_ENABLE_PROJECTS=${_enable_projects}"

post_patch() {
	if [ "$_lldb_enable" = "yes" ]; then
		if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
			vsed -i 's|__ptrace_request|int|g' \
				${wrksrc}/lldb/source/Plugins/Process/Linux/NativeProcessLinux.cpp
		fi
		# disable docs for lldb as they fail to generate
		vsed -i '/add_subdirectory(docs)/d' \
			${wrksrc}/lldb/CMakeLists.txt
	fi

	# update config.guess for better platform detection
	cp $XBPS_COMMONDIR/environment/configure/automake/config.guess \
		${wrksrc}/llvm/cmake

	# fix linker failures on some archs
	vsed -i 's,check_library_exists(gcc_s .*,set(LIBCXXABI_HAS_GCC_S_LIB ON),' \
		${wrksrc}/libcxxabi/cmake/config-ix.cmake
	vsed -i 's,check_library_exists(gcc .*,set(LIBCXXABI_HAS_GCC_LIB ON),' \
		${wrksrc}/libcxxabi/cmake/config-ix.cmake

	# need libssp_nonshared on some musl platforms (because of nodefaultlibs)
	case "$XBPS_TARGET_MACHINE" in
		ppc64*) ;;
		ppc*-musl|i686-musl|mips*-musl)
			vsed -i 's,^# Setup flags.$,add_library_flags(ssp_nonshared),' \
				${wrksrc}/libunwind/src/CMakeLists.txt
			vsed -i 's,^# Setup flags.$,add_library_flags(ssp_nonshared),' \
				${wrksrc}/libcxxabi/src/CMakeLists.txt
			vsed -i 's,#ssp,,' ${wrksrc}/libcxx/CMakeLists.txt
			;;
	esac
}

pre_configure() {
	local triplet

	# Vastly reduce size of debugging symbols:
	CFLAGS=${CFLAGS/ -g/ -g1}
	CXXFLAGS=${CXXFLAGS/ -g/ -g1}

	# since gcc9, the build likes to blow up for ppc32 apparently because
	# of clang being too large for a 24-bit relative call to the PLT, so
	# optimize for size instead
	case "$XBPS_TARGET_MACHINE" in
		ppc64*) ;;
		mips*-musl|ppc*) configure_args+=" -DVOID_CXX_OPT_FLAGS=-Os" ;;
		armv*) configure_args+=" -DVOID_GCC_BUG_109180_WORKAROUND=ON" ;;
	esac

	if [ "$CROSS_BUILD" ]; then
		msg_normal "Building host tblgen\n"
		mkdir -p build/HOST
		cd build/HOST
		CC="$BUILD_CC" CXX="$BUILD_CXX" CFLAGS="$BUILD_CFLAGS" \
			CXXFLAGS="$BUILD_CXXFLAGS" LDFLAGS="$BUILD_LDFLAGS" \
			cmake ../.. -DCMAKE_BUILD_TYPE=Release \
			-DCMAKE_INSTALL_PREFIX=/usr/lib/llvm17 \
			-DLLVM_ENABLE_RUNTIMES=${_enable_runtimes} \
			-DLLVM_ENABLE_PROJECTS=${_enable_projects}
		make ${makejobs} -C utils/TableGen
		make ${makejobs} -C tools/clang/utils/TableGen
		make ${makejobs} -C tools/clang/tools/extra/clang-tidy/misc/ConfusableTable
		make ${makejobs} -C tools/clang/tools/extra/pseudo/gen
		[ "$_lldb_enable" = "yes" ] && make ${makejobs} -C tools/lldb/utils/TableGen
		configure_args+=" -DLLVM_TABLEGEN=${wrksrc}/llvm/build/HOST/bin/llvm-tblgen"
		configure_args+=" -DCLANG_TABLEGEN=${wrksrc}/llvm/build/HOST/bin/clang-tblgen"
		configure_args+=" -DCLANG_TIDY_CONFUSABLE_CHARS_GEN=${wrksrc}/llvm/build/HOST/bin/clang-tidy-confusable-chars-gen"
		configure_args+=" -DCLANG_PSEUDO_GEN=${wrksrc}/llvm/build/HOST/bin/clang-pseudo-gen"
		[ "$_lldb_enable" = "yes" ] && configure_args+=" -DLLDB_TABLEGEN=${wrksrc}/llvm/build/HOST/bin/lldb-tblgen"
		cd ../..
	fi

	case "$XBPS_TARGET_MACHINE" in
	arm*-musl|i686-musl)
		# sanitizer code is broken since it duplicates some libc bits
		configure_args+=" -DCOMPILER_RT_BUILD_SANITIZERS=OFF"
		;;
	esac

	case "$XBPS_TARGET_MACHINE" in
		i686*) _arch="X86";;
		x86_64*) _arch="X86";;
		armv5*) _arch="Armv5te";;
		armv6*) _arch="Armv6";;
		armv7*) _arch="Armv7";;
		aarch64*) _arch="AArch64";;
		mips*) _arch="Mips";;
		ppc*) _arch="PowerPC";;
		riscv64*) _arch="RISCV64";;
	esac

	triplet=${XBPS_CROSS_TRIPLET:-$XBPS_TRIPLET}

	configure_args+=" -DLLVM_TARGET_ARCH=${_arch}"
	configure_args+=" -DLLVM_HOST_TRIPLE=${triplet}"
	configure_args+=" -DLLVM_DEFAULT_TARGET_TRIPLE=${triplet}"
}

post_install() {
	local _file _header _fname _bname _group
	cd build
	# cmake -DCMAKE_INSTALL_PREFIX=${DESTDIR}/usr -P cmake_install.cmake

	# Required for multilib.
	# if [ "$XBPS_TARGET_MACHINE" = "x86_64" ]; then
	# 	for _header in llvm-config; do
	# 		mv ${DESTDIR}/usr/include/llvm/Config/${_header}{,-64}.h
	# 		vinstall ${FILESDIR}/llvm-Config-${_header}.h 644 \
	# 			usr/include/llvm/Config ${_header}.h
	# 	done
	# fi

	# Remove llvm-config-host in cross builds.
	if [ "$CROSS_BUILD" ]; then
		rm -f ${DESTDIR}/usr/lib/llvm17/bin/llvm-config-host
	fi

	for _file in ${DESTDIR}/usr/lib/llvm17/bin/*; do
		_fname="${_file##*/}"
		ln -sf "../lib/llvm17/bin/$_fname" \
			"${DESTDIR}/usr/bin/${_fname}-17"
	done

	rm -f ${DESTDIR}/usr/bin/clang-17-17
	for _file in clang clang++ clang-cpp; do
		ln -sf "../lib/llvm17/bin/$_file" \
			"${DESTDIR}/usr/bin/${_file}-17"
	done

	vmkdir usr/share/man/man1
	for _file in ${DESTDIR}/usr/lib/llvm17/share/man/man1/*; do
		_fname="${_file##*/}"
		_bname="${_fname%.1}"
		mv "${_file}" \
			"${DESTDIR}/usr/share/man/man1/${_bname}-17.1"
	done

	for _group in ftdetect ftplugin indent syntax; do
		vmkdir "usr/share/vim/vimfiles/$_group"
		for _file in "utils/vim/$_group"/*; do
			_fname="${_file##*/}"
			_bname="${_fname%.vim}"
			vinstall "${_file}" 644 \
				"usr/share/vim/vimfiles/$_group" \
				"${_bname}-17.vim"
		done
	done

	for _v in ${version} 17; do
		vmkdir "usr/lib/clang/${_v}"
		ln -sf ../../llvm17/lib/clang/17/lib \
			"${DESTDIR}/usr/lib/clang/${_v}/"
		ln -sf ../../llvm17/lib/clang/17/include \
			"${DESTDIR}/usr/lib/clang/${_v}/"
		ln -sf ../../lib/llvm17/lib/clang/17/include \
			"${DESTDIR}/usr/include/clang/${_v}"
	done

	for _file in ${DESTDIR}/usr/lib/llvm17/lib/lib*.so.17; do
		_fname="${_file##*/}"
		ln -sf "llvm17/lib/${_fname}" "${DESTDIR}/usr/lib"
	done

	# Install asan_symbolize
	vbin ../compiler-rt/lib/asan/scripts/asan_symbolize.py \
		asan_symbolize-17

	# Install libcxxabi headers
	vinstall ${wrksrc}/libcxxabi/include/__cxxabi_config.h 644 \
		usr/lib/llvm17/include
	vinstall ${wrksrc}/libcxxabi/include/cxxabi.h 644 \
		usr/lib/llvm17/include

	# Install libunwind headers
	vinstall ${wrksrc}/libunwind/include/__libunwind_config.h 644 \
		usr/lib/llvm17/include
	vinstall ${wrksrc}/libunwind/include/libunwind.h 644 \
		usr/lib/llvm17/include
	vinstall ${wrksrc}/libunwind/include/unwind.h 644 \
		usr/lib/llvm17/include
	vinstall ${wrksrc}/libunwind/include/mach-o/compact_unwind_encoding.h \
		644 usr/lib/llvm17/include/mach-o
}

_vbinsplit() {
	local _fname
	for _fname
	do
		vmove "usr/bin/${_fname}-17"
		vmove "usr/lib/llvm17/bin/${_fname}"
	done
}

clang-analyzer17_package() {
	pycompile_dirs="usr/share/scan-view"
	depends="clang17-${version}_${revision} python3 perl"
	short_desc+=" - A source code analysis framework"
	homepage="https://clang-analyzer.llvm.org/"
	pkg_install() {
		vmove "usr/bin/scan-*"
		vmove "usr/lib/llvm17/bin/scan-*"
		vmove "usr/lib/llvm17/lib/libscanbuild"
		vmove "usr/lib/llvm17/libexec/*-analyzer"
		vmove "usr/lib/llvm17/libexec/analyze-*"
		vmove "usr/lib/llvm17/libexec/intercept-*"
		vmove "usr/lib/llvm17/share/scan-*"
		vmove "usr/share/man/man1/scan-*"
	}
}

clang-tools-extra17_package() {
	lib32disabled=yes
	depends="clang17-${version}_${revision} python3"
	short_desc+=" - Extra Clang tools"
	homepage="https://clang.llvm.org/extra/"
	pkg_install() {
		local _file
		_vbinsplit \
			clang-apply-replacements \
			clange-change-namespace \
			clang-doc \
			clang-include-fixer \
			clang-move \
			clang-pseudo \
			clang-query \
			clang-reorder-fields \
			clang-tidy \
			clangd \
			find-all-symbols \
			hmaptool \
			modularize \
			pp-trace \

		vmove usr/lib/llvm17/include/clang-tidy
		vmove "usr/lib/llvm17/lib/libclangApplyReplacements*"
		vmove "usr/lib/llvm17/lib/libclangChangeNamespace*"
		vmove "usr/lib/llvm17/lib/libclangDaemon*"
		vmove "usr/lib/llvm17/lib/libclangDoc*"
		vmove "usr/lib/llvm17/lib/libclangIncludeCleaner*"
		vmove "usr/lib/llvm17/lib/libclangIncludeFixer*"
		vmove "usr/lib/llvm17/lib/libclangMove*"
		vmove "usr/lib/llvm17/lib/libclangPseudo*"
		vmove "usr/lib/llvm17/lib/libclangReorderFields*"
		vmove "usr/lib/llvm17/lib/libclangQuery*"
		vmove "usr/lib/llvm17/lib/libclangTidy*"
		vmove "usr/lib/llvm17/lib/libclangd*"
		vmove "usr/lib/llvm17/lib/libfindAllSymbols*"
		vmove "usr/lib/llvm17/share/clang/*find-all-symbols*"
		vmove "usr/lib/llvm17/share/clang/*include-fixer*"
		vmove "usr/lib/llvm17/share/clang/*tidy*"
		vmove usr/lib/llvm17/share/doc/LLVM/clang-tools
		vmove "usr/share/man/man1/extraclangtools-17.1"
	}
}

clang17_package() {
	lib32disabled=yes
	depends="libstdc++-devel libgcc-devel  binutils ${XBPS_TARGET_LIBC}-devel
	 libclang17-${version}_${revision}"
	short_desc+=" - C language family frontend"
	homepage="https://clang.llvm.org/"
	pkg_install() {
		vmove "usr/bin/*clang*"
		vmove "usr/lib/llvm17/bin/*clang*"
		_vbinsplit c-index-test diagtool
		vmove usr/lib/llvm17/include/clang
		vmove usr/lib/llvm17/include/clang-c
		vmove usr/lib/llvm17/lib/clang
		for _v in "${version}" 17; do
			vmove "usr/lib/clang/${_v}/lib"
			vmove "usr/lib/clang/${_v}/include"
			vmove "usr/include/clang/${_v}/include"
		done
		vmove usr/lib/llvm17/lib/cmake/clang
		vmove "usr/lib/llvm17/lib/libclang*.a"
		vmove "usr/lib/llvm17/lib/libclang*.so"
		vmove usr/lib/llvm17/share/clang
		vmove usr/lib/llvm17/share/doc/LLVM/clang
		vmove usr/share/man/man1/clang-17.1
		vmove usr/share/man/man1/diagtool-17.1
	}
}

libclang17_package() {
	short_desc+=" - C frontend runtime library"
	pkg_install() {
		vmove "usr/lib/libclang.so.*"
		vmove "usr/lib/llvm17/lib/libclang.so.*"
	}
}

libclang-cpp17_package() {
	short_desc+=" - C frontend runtime library (C++ interface)"
	pkg_install() {
		vmove "usr/lib/libclang-cpp.so.*"
		vmove "usr/lib/llvm17/lib/libclang-cpp.so.*"
	}
}

lld17_package() {
	lib32disabled=yes
	short_desc+=" - linker"
	homepage="https://lld.llvm.org"
	pkg_install() {
		_vbinsplit "ld.lld*" "ld64.lld*" "lld*" wasm-ld
		vmove usr/lib/llvm17/share/doc/LLVM/lld
	}
}

lld17-devel_package() {
	lib32disabled=yes
	short_desc+=" - linker - development files"
	homepage="https://lld.llvm.org"
	depends="lld17>=${version}_${revision}"
	pkg_install() {
		vmove usr/lib/llvm17/include/lld
		vmove usr/lib/llvm17/lib/cmake/lld
		vmove "usr/lib/llvm17/lib/liblld*a"
	}
}

lldb17_package() {
	lib32disabled=yes
	depends+=" python3-six"
	short_desc+=" - LLDB debugger"
	homepage="https://lldb.llvm.org/"
	pkg_install() {
		vmove "usr/bin/*lldb*"
		vmove "usr/lib/llvm17/bin/*lldb*"
		vmove "usr/lib/llvm17/lib/liblldb*so.*"
		vmove "usr/lib/llvm17/${py3_sitelib#usr/}/lldb"
	}
}

# TODO

lldb17-devel_package() {
	lib32disabled=yes
	depends="lldb17>=${version}_${revision}"
	short_desc+=" - LLDB debugger - development files"
	pkg_install() {
		vmove usr/include/lldb
		vmove "usr/lib/liblldb*.so"
	}
}

llvm-libunwind17_package() {
	short_desc+=" - libunwind"
	pkg_install() {
		vmove "usr/lib/libunwind.so.*"
	}
}

llvm-libunwind17-devel_package() {
	short_desc+=" - libunwind - development files"
	depends="llvm-libunwind17>=${version}_${revision}"
	conflicts="libunwind-devel>=0"
	pkg_install() {
		vmove usr/include/mach-o
		vmove "usr/include/*unwind*"
		vmove "usr/lib/libunwind.a"
		vmove "usr/lib/libunwind.so"
		vmove usr/share/doc/LLVM/libunwind
	}
}

libcxxabi17_package() {
	short_desc+=" - low level support for libc++"
	pkg_install() {
		vmove "usr/lib/libc++abi.so.*"
	}
}

libcxxabi17-devel_package() {
	short_desc+=" - low level support for libc++ - development files"
	depends="libcxxabi17>=${version}_${revision}"
	pkg_install() {
		vmove "usr/include/*cxxabi*"
		vmove "usr/lib/libc++abi.so"
		vmove "usr/lib/libc++abi.a"
	}
}

libcxx17_package() {
	short_desc+=" - C++ standard library"
	pkg_install() {
		vmove "usr/lib/libc++.so.*"
	}
}

libcxx17-devel_package() {
	short_desc+=" - C++ standard library - development files"
	depends="libcxx17>=${version}_${revision}"
	pkg_install() {
		vmove usr/include/c++
		vmove "usr/lib/libc++.so"
		vmove "usr/lib/libc++.a"
		vmove "usr/lib/libc++experimental.a"
		vmove usr/share/doc/LLVM/libcxx
	}
}

libomptarget17_package() {
	short_desc+=" - Clang OpenMP for target"
	pkg_install() {
		vmove "usr/lib/libomptarget.*.so.*"
	}
}

libomp17_package() {
	short_desc+=" - Clang OpenMP support library"
	pkg_install() {
		vmove usr/lib/libarcher.so
		vmove usr/lib/libompd.so
		# vmove "usr/lib/libomptarget.rtl.*.so"
		vmove "usr/lib/libomp*.so.*"
	}
}

libomp17-devel_package() {
	short_desc+=" - Clang OpenMP support library - development files"
	depends="libomp17>=${version}_${revision}"
	pkg_install() {
		vmove "usr/include/omp*.h"
		vmove "usr/lib/clang/${version}/include/omp*.h"
		vmove "usr/lib/libarcher*"
		vmove "usr/lib/libomp*.so"
		vmove usr/lib/cmake/openmp
		vmove usr/share/doc/LLVM/openmp
		vmove usr/share/man/man1/llvmopenmp.1
	}
}

libllvm17_package() {
	short_desc+=" - runtime library"
	pkg_install() {
		vmove "usr/lib/libLLVM-*.so*"
	}
}
