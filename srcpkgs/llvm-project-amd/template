# Template file for 'llvm-project-amd'
pkgname=llvm-project-amd
version=5.6.1
revision=1
build_wrksrc=llvm
build_style=cmake
_llvm_root=${XBPS_BUILDDIR}/${pkgname}-${version}
configure_args=" -DCMAKE_BUILD_TYPE=Release
	-DLLVM_ENABLE_PROJECTS=llvm;clang;lld 
	-DLLVM_EXTERNAL_PROJECTS=device-libs;comgr;hipcc
	-DLLVM_EXTERNAL_DEVICE_LIBS_SOURCE_DIR=${_llvm_root}/amd/device-libs
	-DLLVM_EXTERNAL_COMGR_SOURCE_DIR=${_llvm_root}/amd/comgr
	-DLLVM_EXTERNAL_HIPCC_SOURCE_DIR=${_llvm_root}/amd/hipcc
	-DLLVM_TARGETS_TO_BUILD=AMDGPU;X86
	-DLLVM_ENABLE_ASSERTIONS=ON
	-DLLVM_ENABLE_BINDINGS=OFF 
	-DLLVM_INCLUDE_BENCHMARKS=OFF
	-DLLVM_BUILD_LLVM_DYLIB=OFF
	-DLLVM_LINK_LLVM_DYLIB=OFF
	-DCLANG_LINK_CLANG_DYLIB=OFF
	-DLIBCLANG_BUILD_STATIC=ON
	-DENABLE_SHARED=OFF
	-DBUILD_TESTING=OFF
"
#	-DCMAKE_INSTALL_PREFIX=/usr/lib/rocm
#	-DCMAKE_PREFIX_PATH=/usr/lib/rocm
#	-DCMAKE_INSTALL_RPATH=/usr/lib
#	-DCMAKE_INSTALL_RPATH_USE_LINK_PATH=True
hostmakedepends="pkg-config git python3 ROCm-cmake"
makedepends="libffi-devel ncurses-libtinfo-devel zlib-devel libxml2-devel libzstd-devel libedit-devel"
depends=""
short_desc="LLVM Project for ROCm"
maintainer="Daniel Martinez <danielmartinez@airmail.cc>"
license="MIT"
homepage="https://github.com/RadeonOpenCompute/llvm-project"
_llvm_ref="aomp-18.0-0"
distfiles="https://api.github.com/repos/ROCm/llvm-project/tarball/${_llvm_ref}>llvm-project-amd-${_llvm_ref}.tar.gz"
checksum=f8f9eaf4d72de118c6e73b402a115edd62f787d9a8bd0b68d83373e6faa4ac49
#distfiles="https://github.com/ROCm/llvm-project/archive/refs/tags/rocm-${version}.tar.gz>llvm-project-${version}.tar.gz
#https://github.com/ROCm/HIPCC/archive/refs/tags/rocm-${version}.tar.gz>HIPCC-${version}.tar.gz
#https://github.com/ROCm/ROCm-CompilerSupport/archive/refs/tags/rocm-${version}.tar.gz>comgr-${version}.tar.gz
#https://github.com/ROCm/ROCm-Device-Libs/archive/refs/tags/rocm-${version}.tar.gz>device-libs-${version}.tar.gz "
#checksum="045e43c0c4a3f4f2f1db9fb603a4f1ea3d56e128147e19ba17909eb57d7f08e5
# 5800fac92b841ef6f52acda78d9bf86f83970bec0fb848a6265d239bdb7eb51a
# 0a85d84619f98be26ca7a32c71f94ed3c4e9866133789eabb451be64ce739300
# f0dfab272ff936225bfa1e9dabeb3c5d12ce08b812bf53ffbddd2ddfac49761c"
python_version=3
subpackages="comgr ROCm-device-libs llvm-project-amd-devel hipcc"

_llvm_version=18
#_llvm_version=16.0.0

#post_extract() {
#	mv llvm-project-rocm-${version} llvm
#	mkdir -p ${_llvm_dir}/amd
#	mv ${_llvm_dir}/../ROCm-Device-Libs-rocm-${version} ${_llvm_dir}/amd/device-libs
#	mv ${_llvm_dir}/../ROCm-CompilerSupport-rocm-${version}/lib/comgr ${_llvm_dir}/amd/comgr
#	mv ${_llvm_dir}/../HIPCC-rocm-${version} ${_llvm_dir}/amd/hipcc
#}

#pre_configure() {
#	cd llvm-project-rocm-${version}/llvm
#}

comgr_package() {
	short_desc+="ROCm Code Object Manager"
##	depends="llvm-project-amd>=${version}_${revision}"
	pkg_install() {
		vmove /usr/lib/cmake/amd_comgr
#		vmove /usr/share/doc/amd_comgr
		vmove "/usr/lib/libamd_comgr.*"
		vmkdir /usr/include/amd_comgr
		vcopy build/tools/comgr/include/amd_comgr.h /usr/include/amd_comgr
	}
}


ROCm-device-libs_package() {
	short_desc+="ROCm Device Libraries"
#	depends="llvm-project-amd>=${version}_${revision}"
	pkg_install() {
		vmove /usr/amdgcn
		vmove /usr/lib/cmake/AMDDeviceLibs/AMDDeviceLibsConfig.cmake
	}
}

hipcc_package() {
	short_desc+="HIP Compiler Driver"
	pkg_install() {
		vmove "/usr/bin/hip*"
		vmove /usr/hip
	}
}

llvm-project-amd-devel_package() {
	short_desc+=" - development files"
	depends="llvm-project-amd>=${version}_${revision}"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/cmake
		vmove "usr/lib/*.a"
		vmove "/usr/lib/clang/${_llvm_version}/include"
#		vmove "/usr/lib/clang/${_llvm_version}/lib/linux/*.a"
#		vmove "/usr/lib/clang/${_llvm_version}/lib/linux/*.a.syms"
#		vmove "/usr/lib/clang/${_llvm_version}/lib/linux/*.o"
#		vmove "/usr/lib/clang/${_llvm_version}/share"
		vmove /usr/share
		vmove /usr/lib/libscanbuild
		vmove /usr/lib/libear
	}
}
