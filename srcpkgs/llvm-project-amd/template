# Template file for 'llvm-project-amd'
pkgname=llvm-project-amd
version=5.6.1
revision=1
build_wrksrc=llvm
build_style=cmake
_llvm_root=${XBPS_BUILDDIR}/${pkgname}-${version}
configure_args=" -DCMAKE_BUILD_TYPE=Release
	-DLLVM_ENABLE_PROJECTS=llvm;clang;lld 
	-DLLVM_EXTERNAL_PROJECTS=device-libs;comgr;hipcc
	-DLLVM_EXTERNAL_DEVICE_LIBS_SOURCE_DIR=${_llvm_root}/amd/device-libs
	-DLLVM_EXTERNAL_COMGR_SOURCE_DIR=${_llvm_root}/amd/comgr
	-DLLVM_EXTERNAL_HIPCC_SOURCE_DIR=${_llvm_root}/amd/hipcc
	-DLLVM_TARGETS_TO_BUILD=AMDGPU;X86
	-DLLVM_ENABLE_ASSERTIONS=ON
	-DLLVM_ENABLE_BINDINGS=OFF 
	-DLLVM_INCLUDE_BENCHMARKS=OFF
	-DLLVM_BUILD_LLVM_DYLIB=OFF
	-DLLVM_LINK_LLVM_DYLIB=OFF
	-DCLANG_LINK_CLANG_DYLIB=OFF
	-DLIBCLANG_BUILD_STATIC=ON
	-DENABLE_SHARED=OFF
	-DBUILD_TESTING=OFF
"
hostmakedepends="pkg-config git python3 ROCm-cmake"
makedepends="libffi-devel ncurses-libtinfo-devel zlib-devel libxml2-devel libzstd-devel libedit-devel"
depends=""
short_desc="LLVM Project for ROCm"
maintainer="Daniel Martinez <danielmartinez@airmail.cc>"
license="MIT"
homepage="https://github.com/RadeonOpenCompute/llvm-project"
_llvm_ref="aomp-18.0-0"
distfiles="https://api.github.com/repos/ROCm/llvm-project/tarball/${_llvm_ref}>llvm-project-amd-${_llvm_ref}.tar.gz"
checksum=f8f9eaf4d72de118c6e73b402a115edd62f787d9a8bd0b68d83373e6faa4ac49
python_version=3
subpackages="comgr ROCm-device-libs llvm-project-amd-devel hipcc"

_llvm_version=18

comgr_package() {
	short_desc+="ROCm Code Object Manager"
	pkg_install() {
		vmove /usr/lib/cmake/amd_comgr
		vmove "/usr/lib/libamd_comgr.*"
		vmkdir /usr/include/amd_comgr
		vcopy build/tools/comgr/include/amd_comgr.h /usr/include/amd_comgr
	}
}


ROCm-device-libs_package() {
	short_desc+="ROCm Device Libraries"
	pkg_install() {
		vmove /usr/amdgcn
		vmove /usr/lib/cmake/AMDDeviceLibs/AMDDeviceLibsConfig.cmake
	}
}

hipcc_package() {
	short_desc+="HIP Compiler Driver"
	conflicts="HIP"
	pkg_install() {
		vmove "/usr/bin/hip*"
		vmove /usr/hip
	}
}

llvm-project-amd-devel_package() {
	short_desc+=" - development files"
	depends="llvm-project-amd-${version}_${revision}"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/cmake
		vmove "usr/lib/*.a"
		vmove "/usr/lib/clang/${_llvm_version}/include"
		vmove /usr/share
		vmove /usr/lib/libscanbuild
		vmove /usr/lib/libear
	}
}
