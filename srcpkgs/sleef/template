# Template file for 'sleef'
pkgname=sleef
version=3.6.1
revision=1
build_style=cmake
configure_args="-DSLEEF_BUILD_INLINE_HEADERS=YES
 -DBUILD_SHARED_LIBS=YES
 -DSLEEF_BUILD_QUAD=YES
 -DSLEEF_BUILD_DFT=YES"
makedepends="libgomp-devel openssl-devel gmp-devel fftw-devel mpfr-devel"
short_desc="SIMD Library for Evaluating Elementary Functions"
maintainer="Daniel Martinez <danielmartinez@cock.li>"
license="BSL-1.0"
homepage="https://sleef.org/"
changelog="https://raw.githubusercontent.com/shibatch/sleef/master/CHANGELOG.md"
distfiles="https://github.com/shibatch/sleef/archive/refs/tags/${version}.tar.gz"
checksum=441dcf98c0f22e5d5e553d007f3b93e89eb58e4c66e340da8af5e7f67d1dc24c

if [ "$CROSS_BUILD" ]; then
	configure_args+=" -DNATIVE_BUILD_DIR=${XBPS_BUILDDIR}/${pkgname}-${version}/native"
fi

case "$XBPS_TARGET_MACHINE" in
	i686*|x86_64*|ppc64le*) makedepends+=" libquadmath-devel";;
esac

case "$XBPS_TARGET_MACHINE" in
	i686*|armv*) configure_args+=" -DSLEEF_BUILD_TESTS=NO";;
esac

pre_configure() {
	if [ "$CROSS_BUILD" ]; then
		cmake -S . \
			-DCMAKE_C_COMPILER="$CC_FOR_BUILD" \
			-DCMAKE_CXX_COMPILER="$CXX_FOR_BUILD" \
			-DCMAKE_C_FLAGS="$BUILD_CFLAGS" \
			-DCMAKE_CXX_FLAGS="$BUILD_CXXFLAGS" \
			$configure_args \
			-G Ninja \
			-B native
	fi
}

pre_build() {
	if [ "$CROSS_BUILD" ]; then
		cmake --build native ${makejobs}
	fi
}

do_check() {
	cd build
	_ctest_exclude="iut$"
	_ctest_exclude+="|iutpurecfma_scalar"
	_ctest_exclude+="|iutypurecfma_scalar"
	_ctest_exclude+="|iutipurecfma_scalar"
	if [ "$XBPS_TARGET_LIBC" = musl ]; then
		# tests depend on libmvec, which is not available on musl
		_ctest_exclude+="|mveclibtest.*"
	fi
	ctest ${makejobs} -E ${_ctest_exclude}
}

sleef-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/cmake
		vmove usr/lib/pkgconfig
		vmove "usr/lib/*.so"
	}
}
