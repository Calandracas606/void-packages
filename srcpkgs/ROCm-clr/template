# Template file for 'ROCm-clr'
pkgname=ROCm-clr
version=6.3.0
revision=1
build_style=cmake
_clr_dir="${XBPS_BUILDDIR}/${pkgname}-${version}"
_hip_dir="${_clr_dir}/HIP"
_rocm_prefix=usr/lib/rocm
configure_args="
 -DCMAKE_INSTALL_PREFIX=/${_rocm_prefix}
 -DCMAKE_PREFIX_PATH=${XBPS_CROSS_BASE}/${_rocm_prefix}
 -DCLR_BUILD_HIP=ON
 -DHIP_ENABLE_ROCPROFILER_REGISTER=OFF
 -DHIP_COMMON_DIR=${_hip_dir}
 -DHIPCC_BIN_DIR=/${_rocm_prefix}/bin
 -DROCM_PATH=/${_rocm_prefix}
"
hostmakedepends="pkg-config xxd git python3-robotpy-cppheaderparser"
makedepends="llvm-amd-devel ROCm-cmake hipcc ROCr-Runtime-devel comgr libnuma-devel
 libffi-devel libedit-devel MesaLib-devel ncurses-libtinfo-devel libxml2-devel libzstd-devel"
depends="hipcc"
short_desc="AMD CLR - Compute Language Runtimes"
maintainer="Daniel Martinez <danielmartinez@cock.li>"
license="MIT"
homepage="https://github.com/ROCm-Developer-Tools/clr"
distfiles="https://github.com/ROCm-Developer-Tools/clr/archive/refs/tags/rocm-${version}.tar.gz
 https://github.com/ROCm-Developer-Tools/HIP/archive/refs/tags/rocm-${version}.tar.gz>HIP-${version}.tar.gz"
checksum="829e61a5c54d0c8325d02b0191c0c8254b5740e63b8bfdb05eec9e03d48f7d2c
 d8dba8cdf05463afb7879de2833983cafa6a006ba719815a35b96d9b92fc7fc4"
skip_extraction="HIP-${version}.tar.gz"

export CLR_DIR="${_clr_dir}"
export HIP_DIR="${_hip_dir}"
export ROCM_PATH="/${_rocm_prefix}"

post_extract() {
	vsrcextract -C ${_hip_dir} HIP-${version}.tar.gz
}

post_install() {
	vlicense ${_clr_dir}/LICENCE
	vlicense ${_clr_dir}/hipamd/LICENSE.txt

	vmkdir "usr/bin"
	for _f in ${DESTDIR}/${_rocm_prefix}/bin/*; do
		local _base=$(basename "${_f}")
		ln -s "../lib/rocm/bin/${_base}" "${DESTDIR}/usr/bin"
	done

	for _f in ${DESTDIR}/${_rocm_prefix}/lib64/lib*; do
		local _base=$(basename "${_f}")
		ln -s "rocm/lib64/${_base}" "${DESTDIR}/usr/lib"
	done
}
